<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GE Log√≠stica - Sistema de Cotizaci√≥n de Fletes (MVC)</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<style>
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        background: #f1f5f9;
        color: #1e293b;
        margin: 0;
        padding: 0;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 12px 48px 12px;
    }
    .card {
        background: rgba(251, 146, 60, 0.13); /* naranja transl√∫cido */
        border-radius: 14px;
        box-shadow: 0 2px 12px #0001;
        padding: 32px 24px 28px 24px;
        margin-bottom: 32px;
        border: 1px solid #fb923c33;
        transition: box-shadow 0.2s;
    }
    .card h2 {
        color: #1e40af;
        margin-top: 0;
        margin-bottom: 18px;
        font-size: 1.35em;
        font-weight: 700;
        letter-spacing: 0.01em;
    }
    .form-group label {
        font-weight: 500;
        color: #1e293b;
        margin-bottom: 4px;
        display: block;
    }
    input, select, textarea {
        border: 1.5px solid #fb923c !important;
        border-radius: 6px;
        padding: 7px 10px;
        font-size: 1em;
        width: 100%;
        background: #fff;
        margin-bottom: 0;
        box-sizing: border-box;
        transition: border 0.2s;
    }
    input:focus, select:focus, textarea:focus {
        outline: none !important;
        border-color: #ea580c !important;
        box-shadow: 0 0 0 2px #fb923c44;
        background: #fff7ed;
    }
    button, .btn {
        border: none;
        border-radius: 6px;
        padding: 8px 18px;
        font-size: 1em;
        font-weight: 500;
        cursor: pointer;
        background: #2563eb;
        color: #fff;
        transition: background 0.2s, box-shadow 0.2s;
        margin-right: 6px;
    }
    button.btn-secondary, .btn-secondary {
        background: #64748b;
        color: #fff;
    }
    button.btn-danger, .btn-danger {
        background: #ef4444;
        color: #fff;
    }
    button.btn-warning, .btn-warning {
        background: #facc15;
        color: #1e293b;
    }
    button:active, button:focus {
        box-shadow: 0 0 0 2px #2563eb44;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 0;
    }
    th, td {
        padding: 10px 8px;
        border: 1px solid #e2e8f0;
        text-align: left;
        font-size: 0.98em;
    }
    th {
        background: #2563eb;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.01em;
    }
    tr:nth-child(even) td {
        background: #f1f5fa;
    }
    .alert {
        border-radius: 6px;
        padding: 10px 16px;
        font-size: 1em;
        margin-bottom: 12px;
    }
    .alert-warning {
        background: #fef9c3;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    .acordeon-pedidos .acordeon-item {
        background: rgba(251,146,60,0.09);
        border: 1px solid #fb923c33;
    }
    @media (max-width: 900px) {
        .container { padding: 8px; }
        .card { padding: 18px 6px; }
        table, th, td { font-size: 0.95em; }
        .modal-dialog { min-width: 90vw; }
    }
</style>
<style>
    .modal-backdrop {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(30,41,59,0.45);
        z-index: 1000;
        display: none;
    }
    .modal.show, .modal-backdrop.show { display: block !important; }
    .modal {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        display: none;
        z-index: 1010;
        align-items: center;
        justify-content: center;
        background: none;
    }
    .modal-dialog {
        margin: auto;
        min-width: 420px;
        max-width: 700px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 8px 32px #0003;
        position: relative;
    }
    .modal-header, .modal-footer { padding: 16px; }
    .modal-title { font-size: 1.1em; font-weight: bold; }
    .modal-body { padding: 16px; }
    .btn-close { background: none; border: none; font-size: 1.3em; cursor: pointer; position: absolute; right: 16px; top: 16px; }

        .config-viaje-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: auto auto;
        gap: 18px 24px;
        align-items: end;
    }
    .config-viaje-grid .observacion-group {
        grid-column: 2 / 3;
        width: 100%;
        margin-top: 10px;
        justify-self: center;
    }
    @media (max-width: 900px) {
        .config-viaje-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 10px;
        }
        .config-viaje-grid .observacion-group {
            grid-column: 1;
            width: 100%;
        }
    }
    @media (max-width: 900px) {
        .config-viaje-grid {
            grid-template-columns: 1fr;
            grid-gap: 10px;
        }
        .config-viaje-grid .observacion-group {
            width: 100%;
            grid-column: 1;
        }
    }
</style>

<body>
        <div id="toastMsg" style="display:none;position:fixed;top:32px;left:50%;transform:translateX(-50%);background:#dc2626;color:#fff;padding:14px 32px;border-radius:8px;z-index:9999;font-size:1.08em;box-shadow:0 2px 12px #0002;transition:opacity 0.3s;opacity:0;">Primero debes diligenciar la Configuraci√≥n del Viaje.</div>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="https://www.gelogistica.co/wp-content/uploads/2025/05/pagina-logo.png" alt="GE Log√≠stica">
                </div>
                <div class="header-text">
                    <h1>Sistema de C√°lculo de Fletes - Modelo </h1>
                    <p>Dimensi√≥n Operativa (Volumen)</p>
                </div>
            </div>
        </header>

        <!-- M√≥dulo 1: Configuraci√≥n del Viaje -->
        <section class="card">
            <h2>Configuraci√≥n del Viaje</h2>
            <form id="configuracion-viaje-form">
                <div class="config-viaje-grid">
                    <!-- Fila 1: 3 columnas -->
                    <div class="form-group">
                        <label for="ruta">Ruta de Transporte:</label>
                        <select id="ruta" onchange="cargarRuta();renderOcupacionVisual();">
                            <!-- Opciones generadas din√°micamente por JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoCamionSeleccionado">Tipo de Cami√≥n:</label>
                        <select id="tipoCamionSeleccionado" onchange="validarCapacidadCamion();renderOcupacionVisual();">
                            <!-- Opciones generadas din√°micamente por JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fechaDespacho">Fecha de Despacho:</label>
                        <input type="date" id="fechaDespacho">
                    </div>
                    <!-- Fila 2: Info de ruta centrada -->
                    <div></div>
                    <div style="grid-column: 2 / 3; width: 100%; margin-top: 10px; justify-self: center; text-align:center;">
                        <div id="infoRuta" class="info-box" style="display:none;">
                            <p style="margin:0 0 4px 0;"><strong>Destinos disponibles:</strong> <span id="destinos"></span></p>
                            <p style="margin:0;"><strong>Distancia:</strong> <span id="distancia"></span> km</p>
                        </div>
                    </div>
                    <div></div>
                </div>
            </form>
        </section>

<script>
// Definir tipos de cami√≥n para el select
const TIPOS_CAMION = [
    "Cami√≥n 25 m¬≥",
    "Cami√≥n 37 m¬≥",
    "Cami√≥n 45 m¬≥"
];
// --- DATOS HARDCODEADOS DE RUTAS Y TARIFAS ---
// ...existing code...

// Autocompletar selects de ruta y tipo de cami√≥n al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Solo rellenar select de tipo de cami√≥n, el de rutas lo gestiona el controlador MVC
    const tipoCamionSelect = document.getElementById('tipoCamionSeleccionado');
    if (tipoCamionSelect) {
        tipoCamionSelect.innerHTML = '<option value="">-- Seleccione tipo de cami√≥n --</option>' +
            TIPOS_CAMION.map((tipo, i) => `<option value="${[25,37,45][i]}">${tipo}</option>`).join('');
    }
});
const RUTAS = [
    "URBANO (SIBATE a Calle 26) (1 a 6 Clientes)",
    "URBANO NORTE SUBA (Calle 26/ a calle 200) (1 a 6 Clientes)",
    "PAQUETERA (ENTREGA CLIENTE) (8 a 12 Clientes)",
    "PLATAFORMA ALKOSTO (PAGA DESCARGUE)",
    "PLATAFORMA SODIMAC EL ZOL",
    "FUNZA - MOSQUERA - MADRID / (incluye entregas en Bogot√°)",
    "MOSQUERA - MADRID - FACATATIVA",
    "ALBAN - SASAIMA - VILLETA - GUADUAS - HONDA",
    "SIBERIA - TENJO - EL ROSAL",
    "SAN FRANCISCO - LA VEGA - SUPATA - NOCAIMA - VILLETA",
    "PTO SALGAR - LA DORADA - HONDA - MARIQUITA - ARMERO - LIBANO",
    "MARIQUITA - FRESNO - MANZANARES - MANIZALEZ",
    "COTA - CHIA - CAJICA - ZIPAQUIRA O SUBACHOQUE",
    "SOPO - TOCANCIPA - GACHANCIPA - CHOCONTA",
    "UBATE - CHIQUINQUIRA",
    "SOPO - GUASCA - LA CALERA",
    "PUENTE NACIONAL - BARBOSA",
    "TUNJA - PAIPA - DUITAMA - SOGAMOSO O MONIQUIRA",
    "VILLA DE LEYVA - RAQUIRA",
    "TUNJA - DUITAMA - SOGAMOSO - SOATA",
    "SOGAMOSO - SOATA - CAPITANEJO",
    "GARAGOA - MONTEREY - AGUAZUL - YOPAL",
    "YOPAL - MANI - PORE - PAZ DE ARIPORO",
    "VILLAVICENCIO",
    "VILLAVICENCIO - RESTREPO - CUMARAL - VILLANUEVA",
    "VILLAVICENCIO - ACACIAS - CASTILLA - SAN CARLOS DE GUAROA",
    "VILLAVICENCIO - SAN MARTIN - GRANADA - SAN JUAN DE ARAMA",
    "VILLAVICENCIO - GRANADA- SAN JOSE DE GUAVIARE",
    "VILLAVICENCIO - PUERTO LOPEZ - PUERTO GAITAN",
    "SILVANIA - FUSAGASUGA",
    "LA MESA - APULO - ANAPOIMA - TOCAIMA - AGUA DE DIOS - RICAURTE",
    "GIRARDOT - MELGAR - ESPINAL- IBAGUE",
    "IBAGUE - ARMENIA",
    "CALI - PUERTO TEJADA",
    "NEIVA",
    "NEIVA - ORTEGA - CHAPARRAL - GUAMO",
    "NEIVA - GARZON",
    "NEIVA - GARZON - PITALITO",
    "NEIVA - GARZON - LA PLATA - PITALITO",
    "NEIVA - GARZON - PITALITO - FLORENCIA",
    "NEIVA - GARZON - PITALITO - FLORENCIA - EL DONCELLO",
    "PITALITO - FLORENCIA - CARTAGENA DEL CHAIRA",
    "DUITAMA - CAPITANEJO - MALAGA",
    "TUNJA - DUITAMA - SAN GIL - BUCARAMANGA",
    "BUCARAMANGA - SAN GIL - FLORIDABLANCA",
    "CUCUTA",
    "BUCARAMANGA - CUCUTA",
    "VALLEDUPAR",
    "BARRANQUILLA",
    "SANTA MARTA",
    "CARTAGENA",
    "URIBIA - MAICAO - RIOHACHA",
    "VILLAVICENCIO - LEJANIAS - VISTAHERMOSA",
    "EL DONCELLLO - SAN VICENTE DEL CAGUAN",
    "SOACHA - GUARNE (ANT)",
    "SOACHA - PEREIRA",
    "MANIZALES - SOACHA"
];



// Interceptar intento de abrir modal de pedido si no est√° habilitado
document.addEventListener('DOMContentLoaded', function() {
    const btnAgregarPedido = document.getElementById('btnAbrirModalPedido');
    btnAgregarPedido.addEventListener('click', function(e) {
        if (btnAgregarPedido.disabled) {
            // Scroll a la secci√≥n de configuraci√≥n del viaje (primer card con h2 correspondiente)
            const seccion = Array.from(document.querySelectorAll('section.card')).find(card => card.querySelector('h2') && card.querySelector('h2').textContent.includes('Configuraci√≥n del Viaje'));
            if (seccion) {
                seccion.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
            // Mostrar mensaje flotante
            const toast = document.getElementById('toastMsg');
            if (toast) {
                toast.style.display = 'block';
                setTimeout(() => { toast.style.opacity = 1; }, 10);
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => { toast.style.display = 'none'; }, 350);
                }, 2600);
            }
            e.preventDefault();
            return false;
        }
    }, true);
});
// --- L√≥gica de Pedidos y Productos ---
let pedidos = [];
let capacidadCamion = 25;
let editandoPedido = false;
let indiceEditando = null;
let nuevoPedido = {
    cliente: '',
    numero: '',
    canal: '',
    productos: [crearProductoVacio()]
};

function crearProductoVacio() {
    return { nombre: '', cantidad: 1, volumenUnitario: 0, pesoUnitario: 0, precioUnitario: 0, destino: '' };
}

function abrirModalPedido() {
    editandoPedido = false;
    indiceEditando = null;
    nuevoPedido = {
        cliente: '',
        numero: '',
        canal: '',
        productos: [crearProductoVacio()]
    };
    renderProductosPedidoForm();
    document.getElementById('pedidoCliente').value = '';
    document.getElementById('pedidoNumero').value = '';
    document.getElementById('pedidoCanal').value = '';
    document.getElementById('modalPedidoTitulo').textContent = 'Agregar Pedido';
        document.getElementById('modalPedido').classList.add('show');
        document.getElementById('modalPedidoBackdrop').classList.add('show');
        document.body.style.overflow = 'hidden';
}

function cerrarModalPedido() {
    document.getElementById('modalPedido').style.display = 'none';
        document.getElementById('modalPedido').classList.remove('show');
        document.getElementById('modalPedidoBackdrop').classList.remove('show');
        document.body.style.overflow = '';
}

    // Cerrar modal al hacer clic fuera
    document.addEventListener('mousedown', function(e) {
        const modal = document.getElementById('modalPedido');
        const backdrop = document.getElementById('modalPedidoBackdrop');
        if (modal.classList.contains('show') && backdrop.classList.contains('show')) {
            if (!modal.querySelector('.modal-dialog').contains(e.target) && backdrop.contains(e.target)) {
                cerrarModalPedido();
            }
        }
    });

    // Cerrar modal con Esc
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') cerrarModalPedido();
    });
function agregarProductoAlPedido() {
    nuevoPedido.productos.push(crearProductoVacio());
    renderProductosPedidoForm();
}

function eliminarProductoDelPedido(idx) {
    if (nuevoPedido.productos.length > 1) {
        nuevoPedido.productos.splice(idx, 1);
        renderProductosPedidoForm();
    }
}

function renderProductosPedidoForm() {
    const cont = document.getElementById('productosPedidoForm');
    cont.innerHTML = '';
    // Opciones de productos de prueba
    const productosPrueba = [
        { nombre: 'LAM UT 200', cantidad: 100, volumenUnitario: 0.16, precioUnitario: 96223, destino: 'Destino 1' },
        { nombre: 'COL MONARCA', cantidad: 6, volumenUnitario: 0.53, precioUnitario: 605406, destino: 'Destino 2' },
        { nombre: 'COL CONFORT PREMIUM', cantidad: 5, volumenUnitario: 0.90, precioUnitario: 734200, destino: 'Destino 3' }
    ];
    nuevoPedido.productos.forEach((prod, idx) => {
        const div = document.createElement('div');
        div.style.display = 'grid';
        div.style.gridTemplateColumns = '2fr 1fr 1fr 1fr 1fr auto';
        div.style.gap = '10px';
        div.style.marginBottom = '8px';
        div.style.alignItems = 'end';
        div.innerHTML = `
            <div class="form-group" style="margin-bottom: 0;">
                <label>Producto:</label>
                <select onchange="if(this.value){cargarProductoPrueba(${idx}, this.value);}else{actualizarProdCampo(${idx}, 'nombre', '');actualizarProdCampo(${idx}, 'cantidad', 1);actualizarProdCampo(${idx}, 'volumenUnitario', 0);actualizarProdCampo(${idx}, 'precioUnitario', 0);actualizarProdCampo(${idx}, 'destino', '');renderProductosPedidoForm();}" style="width:100%;margin-bottom:4px;">
                    <option value="">-- Manual / Nuevo --</option>
                    <option value="0" ${prod.nombre==='LAM UT 200'?'selected':''}>LAM UT 200</option>
                    <option value="1" ${prod.nombre==='COL MONARCA'?'selected':''}>COL MONARCA</option>
                    <option value="2" ${prod.nombre==='COL CONFORT PREMIUM'?'selected':''}>COL CONFORT PREMIUM</option>
                </select>
                <input type="text" value="${prod.nombre}" placeholder="Nombre producto" onchange="actualizarProdCampo(${idx}, 'nombre', this.value)">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Cantidad:</label>
                <input type="number" min="1" value="${prod.cantidad}" onchange="actualizarProdCampo(${idx}, 'cantidad', this.value)">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Vol. Unit. (m¬≥):</label>
                <input type="number" step="0.001" value="${prod.volumenUnitario}" onchange="actualizarProdCampo(${idx}, 'volumenUnitario', this.value)">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Precio Unit. ($):</label>
                <input type="number" step="100" value="${prod.precioUnitario}" onchange="actualizarProdCampo(${idx}, 'precioUnitario', this.value)">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Destino:</label>
                <input type="text" value="${prod.destino}" onchange="actualizarProdCampo(${idx}, 'destino', this.value)">
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProductoDelPedido(${idx})">X</button>
        `;
        cont.appendChild(div);
    });
    // Funci√≥n global para cargar producto de prueba
    window.cargarProductoPrueba = function(idx, val) {
        if (productosPrueba[val]) {
            Object.keys(productosPrueba[val]).forEach(k => {
                actualizarProdCampo(idx, k, productosPrueba[val][k]);
            });
            renderProductosPedidoForm();
        }
    }
}

function actualizarProdCampo(idx, campo, valor) {
    if (campo === 'cantidad' || campo === 'volumenUnitario' || campo === 'pesoUnitario' || campo === 'precioUnitario') {
        valor = parseFloat(valor) || 0;
    }
    nuevoPedido.productos[idx][campo] = valor;
}

function guardarPedido() {
    // Validaciones b√°sicas
    const cliente = document.getElementById('pedidoCliente').value.trim();
    const numero = document.getElementById('pedidoNumero').value.trim();
    const canal = document.getElementById('pedidoCanal').value;
    if (!cliente || !numero || !canal) {
        mostrarAlerta('Completa todos los campos obligatorios del pedido.');
        return;
    }
    if (nuevoPedido.productos.length === 0 || nuevoPedido.productos.some(p => !p.nombre || !p.destino)) {
        mostrarAlerta('Completa los datos de todos los productos y su destino.');
        return;
    }
    const volumenPedido = nuevoPedido.productos.reduce((acc, prod) => acc + (prod.cantidad * prod.volumenUnitario), 0);
    const volumenOcupado = pedidos.reduce((acc, ped) => acc + ped.productos.reduce((a, prod) => a + (prod.cantidad * prod.volumenUnitario), 0), 0);
    let volumenFinal = volumenOcupado + volumenPedido;
    if (editandoPedido) {
        const anterior = pedidos[indiceEditando].productos.reduce((a, prod) => a + (prod.cantidad * prod.volumenUnitario), 0);
        volumenFinal = volumenOcupado - anterior + volumenPedido;
    }
    if (volumenFinal > capacidadCamion) {
        mostrarAlerta('¬°Capacidad del cami√≥n superada!');
        return;
    }
    const pedidoObj = {
        cliente,
        numero,
        canal,
        productos: JSON.parse(JSON.stringify(nuevoPedido.productos))
    };
    if (editandoPedido) {
        pedidos[indiceEditando] = pedidoObj;
    } else {
        pedidos.push(pedidoObj);
    }
    cerrarModalPedido();
    mostrarAlerta('');
    renderPedidosResumen();
    renderOcupacionVisual();
}

function mostrarAlerta(msg) {
    const alerta = document.getElementById('alertaCapacidad');
    if (msg) {
        alerta.textContent = msg;
        alerta.style.display = 'block';
    } else {
        alerta.style.display = 'none';
    }
}

function renderPedidosResumen() {
    const cont = document.getElementById('pedidosResumenContainer');
    if (pedidos.length === 0) {
        cont.innerHTML = '';
        return;
    }
    let html = `<h3 style=\"margin: 0 0 15px 0; font-size: 0.95em; color: #334155;\">Pedidos en el Cami√≥n</h3>`;
    html += `<div class='acordeon-pedidos'>`;
    pedidos.forEach((pedido, idx) => {
        const volTotal = pedido.productos.reduce((acc, prod) => acc + (prod.cantidad * prod.volumenUnitario), 0);
        const subtotal = pedido.productos.reduce((acc, prod) => acc + (prod.cantidad * prod.precioUnitario), 0);
        html += `
        <div class='acordeon-item' style="margin-bottom:8px;border-radius:8px;overflow:hidden;">
            <div class='acordeon-header' style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:12px 18px;background:#f8fafc;font-weight:600;" onclick="toggleAcordeonPedido(${idx})">
                <span><span style='color:#1e40af;'>${pedido.cliente}</span> | Pedido: <b>${pedido.numero}</b> | Canal: <span style='color:#64748b;'>${pedido.canal}</span></span>
                <span style='font-size:0.95em;color:#fb923c;'>Vol: ${volTotal.toFixed(2)} m¬≥ | $${subtotal.toLocaleString()}</span>
                <span id='acordeon-icon-${idx}' style='margin-left:12px;font-size:1.2em;'>‚ñº</span>
            </div>
            <div class='acordeon-body' id='acordeon-body-${idx}' style='display:none;background:#fff;padding:12px 24px 12px 24px;'>
                <div style='overflow-x:auto;'>
                <table style="width:100%;border-collapse:collapse;margin-bottom:8px;">
                    <thead>
                        <tr style='background:#f1f5fa;'>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Producto</th>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Cantidad</th>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Vol. Unit. (m¬≥)</th>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Vol. Total (m¬≥)</th>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Precio Unit.</th>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Valor Total</th>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Destino</th>
                            <th style='padding:6px 8px;border:1px solid #e2e8f0;'>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pedido.productos.map((prod, pidx) => {
                            const volTotal = (prod.cantidad * prod.volumenUnitario).toFixed(2);
                            const valorTotal = (prod.cantidad * prod.precioUnitario).toLocaleString();
                            return `
                            <tr>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>${prod.nombre}</td>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>${prod.cantidad}</td>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>${prod.volumenUnitario}</td>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>${volTotal}</td>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>${prod.precioUnitario}</td>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>$${valorTotal}</td>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>${prod.destino}</td>
                                <td style='padding:6px 8px;border:1px solid #e2e8f0;'>
                                    <button class='btn btn-warning btn-sm' onclick='editarPedido(${idx});setTimeout(()=>{document.querySelectorAll("#productosPedidoForm input")[0].focus();},200)'>Editar</button>
                                    <button class='btn btn-danger btn-sm' onclick='eliminarProductoDesdeAcordeon(${idx},${pidx})'>Eliminar</button>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                </div>
                <div style='margin-top:8px;display:flex;gap:8px;'>
                    <button class='btn btn-secondary btn-sm' onclick='editarPedido(${idx});setTimeout(()=>{window.agregarProductoAlPedido();},200)'>Agregar otro producto</button>
                    <button class='btn btn-warning btn-sm' onclick='editarPedido(${idx})'>Editar Pedido</button>
                    <button class='btn btn-danger btn-sm' onclick='eliminarPedido(${idx})'>Eliminar Pedido</button>
                </div>
            </div>
        </div>`;
    // Eliminar producto desde el acorde√≥n
    window.eliminarProductoDesdeAcordeon = function(pedidoIdx, prodIdx) {
        if (pedidos[pedidoIdx].productos.length > 1) {
            pedidos[pedidoIdx].productos.splice(prodIdx, 1);
            renderPedidosResumen();
            renderOcupacionVisual();
        }
    }
    });
    html += `</div>`;
    cont.innerHTML = html;
    // Cerrar todos los acordeones menos el √∫ltimo agregado
    pedidos.forEach((_, i) => {
        document.getElementById('acordeon-body-' + i).style.display = 'none';
        document.getElementById('acordeon-icon-' + i).textContent = '‚ñº';
    });
// Eliminar llave extra aqu√≠
// Funci√≥n global para el acorde√≥n
window.toggleAcordeonPedido = function(idx) {
    const body = document.getElementById('acordeon-body-' + idx);
    const icon = document.getElementById('acordeon-icon-' + idx);
    if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        body.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}
function editarPedido(idx) {
    editandoPedido = true;
    indiceEditando = idx;
    // Copiar datos del pedido seleccionado
    const pedido = pedidos[idx];
    nuevoPedido = {
        cliente: pedido.cliente,
        numero: pedido.numero,
        canal: pedido.canal,
        productos: JSON.parse(JSON.stringify(pedido.productos))
    };
    renderProductosPedidoForm();
    document.getElementById('pedidoCliente').value = pedido.cliente;
    document.getElementById('pedidoNumero').value = pedido.numero;
    document.getElementById('pedidoCanal').value = pedido.canal;
    document.getElementById('modalPedidoTitulo').textContent = 'Editar Pedido';
    document.getElementById('modalPedido').classList.add('show');
    document.getElementById('modalPedidoBackdrop').classList.add('show');
    document.body.style.overflow = 'hidden';
}
}

function renderOcupacionVisual() {
    const volumenOcupado = pedidos.reduce((acc, ped) => acc + ped.productos.reduce((a, prod) => a + (prod.cantidad * prod.volumenUnitario), 0), 0);
    const porcentajeOcupacion = ((volumenOcupado / capacidadCamion) * 100).toFixed(2);
    const rutaSelect = document.getElementById('ruta');
    const tipoCamionSelect = document.getElementById('tipoCamionSeleccionado');
    const rutaId = rutaSelect && rutaSelect.value ? parseInt(rutaSelect.value) : null;
    let tipoCamion = tipoCamionSelect && tipoCamionSelect.value ? tipoCamionSelect.value : null;
    // Asegurar que el tipo de cami√≥n sea n√∫mero
    if (tipoCamion !== null) tipoCamion = Number(tipoCamion);
    let capacidadTexto = '';
    if (tipoCamion) {
        capacidadTexto = `<span style='font-size:0.95em;display:block;color:#64748b;margin-top:2px;'>Capacidad: ${tipoCamion} m¬≥</span>`;
    }
    let nombreRuta = '';
    if (rutaId && window.appController && window.appController.rutaModel) {
        const rutaObj = window.appController.rutaModel.obtenerRutaPorIdSync(rutaId);
        if (rutaObj && rutaObj.nombre) {
            nombreRuta = `<span style='font-size:0.93em;display:block;color:#334155;margin-top:2px;'>Ruta: <b>${rutaObj.nombre}</b></span>`;
        }
    }
    // Array de rutas con tarifas para jugar con el valor
    const rutasEjemplo = [
        {
            id: 8,
            nombre: 'ALBAN - SASAIMA - VILLETA - GUADUAS - HONDA',
            tarifas: {
                25: 970659,
                37: 997253,
                45: 997253
            }
        }
    ];
    let valorFlete = `<span style='font-size:1em;display:block;color:#2563eb;margin-top:2px;'><b>Valor Flete:</b> `;
    let rutaEjemplo = rutasEjemplo.find(r => r.id === rutaId);
    if (rutaEjemplo && tipoCamion && rutaEjemplo.tarifas[tipoCamion]) {
        valorFlete += `$${rutaEjemplo.tarifas[tipoCamion].toLocaleString('es-CO')}`;
    } else {
        valorFlete += '--';
    }
    valorFlete += `</span>`;
    document.getElementById('porcentajeOcupacion').innerHTML = `<span>${porcentajeOcupacion}%</span>` + capacidadTexto + nombreRuta + `<div style='margin-top:8px;'>${valorFlete}</div>`;
    const visual = document.getElementById('ocupacionVisual');
    // El cami√≥n siempre centrado dentro de la barra
    const barraWidth = 120; // px
    visual.innerHTML = `<div style='width:${barraWidth}px;height:60px;background:#e5e7eb;border-radius:12px;position:relative;overflow:hidden;box-shadow:0 2px 8px #0001;border:2px solid #fb923c;'>
        <div style='width:${porcentajeOcupacion}%;height:100%;background:${porcentajeOcupacion<80?'#60a5fa':(porcentajeOcupacion<100?'#facc15':'#ef4444')};position:absolute;left:0;top:0;'></div>
        <div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:3;pointer-events:none;">
            <span style='font-size:2em;line-height:1;'>üöö</span>
        </div>
    </div>
    <span style='font-size:1.1em;color:#334155;'>${volumenOcupado.toFixed(2)} m¬≥ / ${capacidadCamion} m¬≥</span>`;
}

function eliminarPedido(idx) {
    pedidos.splice(idx, 1);
    renderPedidosResumen();
    renderOcupacionVisual();
}

// Inicializaci√≥n segura tras cargar el DOM
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('btnAbrirModalPedido')) document.getElementById('btnAbrirModalPedido').onclick = abrirModalPedido;
    if (document.getElementById('btnCerrarModalPedido')) document.getElementById('btnCerrarModalPedido').onclick = cerrarModalPedido;
    if (document.getElementById('btnCancelarModalPedido')) document.getElementById('btnCancelarModalPedido').onclick = cerrarModalPedido;
    if (document.getElementById('btnAgregarProductoPedido')) document.getElementById('btnAgregarProductoPedido').onclick = agregarProductoAlPedido;
    if (document.getElementById('btnGuardarPedido')) document.getElementById('btnGuardarPedido').onclick = guardarPedido;
    renderPedidosResumen();
    renderOcupacionVisual();
});


         // --- Validaci√≥n de Configuraci√≥n del Viaje ---
            function validarConfiguracionViajeCompleta() {
                const ruta = document.getElementById('ruta').value;
                const camion = document.getElementById('tipoCamionSeleccionado').value;
                const fecha = document.getElementById('fechaDespacho').value;
                const btnAgregarPedido = document.getElementById('btnAbrirModalPedido');
                const bloqueoMsg = document.getElementById('bloqueoCargaMsg');
                let habilitado = ruta && camion && fecha;
                btnAgregarPedido.disabled = !habilitado;
                if (bloqueoMsg) bloqueoMsg.style.display = habilitado ? 'none' : 'block';
                // Opcional: deshabilitar tambi√©n el resumen de pedidos y otros campos si se requiere
            }
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('ruta').addEventListener('change', validarConfiguracionViajeCompleta);
                document.getElementById('tipoCamionSeleccionado').addEventListener('change', validarConfiguracionViajeCompleta);
                document.getElementById('fechaDespacho').addEventListener('change', validarConfiguracionViajeCompleta);
                validarConfiguracionViajeCompleta();
            });

</script>

        <!-- M√≥dulo 2: Agregar Pedidos/Productos a la Carga -->
        <section class="card" id="carga-camion-section">
                        <div id="modalPedidoBackdrop" class="modal-backdrop"></div>
            <h2>üì¶ Carga del Cami√≥n</h2>
            <div style="background: #eff6ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 3px solid #2563eb;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; align-items: center; gap: 18px;">
                    <div style="text-align:left;">
                        <p style="color: #1e40af; font-size: 0.95em; margin: 0; font-weight: 600;">Agregar pedidos al cami√≥n</p>
                        <p style="color: #64748b; font-size: 0.85em; margin: 5px 0 0 0;">El sistema validar√° que no exceda la capacidad seleccionada</p>
                    </div>
                    <div style="justify-self:center;">
                        <div style="font-size: 0.85em; color: #64748b; text-align:center;">Ocupaci√≥n</div>
                        <div id="ocupacionVisual" style="width:120px;height:60px;background:#e5e7eb;border-radius:12px;position:relative;overflow:hidden;box-shadow:0 2px 8px #0001;border:2px solid #fb923c;display:inline-block;margin-top:4px;"></div>
                    </div>
                    <div style="text-align:right;">
                        <div id="porcentajeOcupacion" style="font-size: 1.3em; font-weight: bold; color: #2563eb; min-width: 60px;">0%</div>
                    </div>
                </div>
            </div>
            <div id="alertaCapacidad" class="alert alert-warning" style="display:none; margin-bottom: 15px;"></div>
            <button class="btn btn-primary mb-3" id="btnAbrirModalPedido" type="button" disabled>Agregar Pedido</button>
            <!-- Modal Pedido -->
            <div id="modalPedido" class="modal" style="display:none;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalPedidoTitulo">Agregar Pedido</h5>
                            <button type="button" class="btn-close" id="btnCerrarModalPedido"></button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Cliente:</label>
                                    <input type="text" id="pedidoCliente" placeholder="Nombre cliente">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>N√∫mero de Pedido:</label>
                                    <input type="text" id="pedidoNumero" placeholder="N¬∞ Pedido">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Canal:</label>
                                    <select id="pedidoCanal">
                                        <option value="">Seleccione canal</option>
                                        <option>Propio</option>
                                        <option>Especializado</option>
                                        <option>Tradicional</option>
                                        <option>Industrial</option>
                                        <option>Moderno</option>
                                    </select>
                                </div>
                            </div>
                            <h4 style="font-size: 0.93em; color: #64748b; margin: 10px 0 5px 0;">Productos del Pedido</h4>
                            <div id="productosPedidoForm"></div>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnAgregarProductoPedido" style="margin-top: 5px;">Agregar otro producto</button>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="btnCancelarModalPedido" style="min-width:120px;">Cancelar</button>
                            <button class="btn btn-success" id="btnGuardarPedido" style="min-width:160px;font-weight:bold;">Registrar Pedido</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="pedidosResumenContainer" style="margin-top: 20px;"></div>
            <div id="bloqueoCargaMsg" class="alert alert-warning" style="display:none; margin-top: 10px;">Primero complete la Configuraci√≥n del Viaje para habilitar la carga del cami√≥n.</div>
   

        </section>

        <!-- M√≥dulo 3: Resumen y C√°lculo del Despacho -->
        <section class="card">
            <h2>Resumen del Despacho</h2>
            <div class="summary-section">
                <h3>Indicadores Operativos</h3>
                <div class="summary-grid">
                    <div class="summary-item"><span id="indicadorOcupacion">Ocupaci√≥n del cami√≥n (%)</span></div>
                    <div class="summary-item"><span id="indicadorDesperdicio">Capacidad desperdiciada (%)</span></div>
                    <div class="summary-item"><span id="indicadorVolumen">Volumen transportado (m¬≥)</span></div>
                    <div class="summary-item"><span id="indicadorTipoCamion">Tipo de cami√≥n utilizado</span></div>
                    <div class="summary-item"><span id="indicadorNumClientes">N√∫mero de clientes por despacho</span></div>
                </div>
                <h3 style="margin-top:24px;">Indicadores Econ√≥micos / Financieros</h3>
                <div class="summary-grid">
                    <div class="summary-item"><span id="indicadorFleteVenta">% Flete sobre venta</span></div>
                    <div class="summary-item"><span id="indicadorFleteCliente">Costo del flete por cliente</span></div>
                    <div class="summary-item"><span id="indicadorFleteProducto">Costo del flete por producto</span></div>
                    <div class="summary-item"><span id="indicadorVentaSinIVA">Valor total de venta sin IVA</span></div>
                    <div class="summary-item"><span id="indicadorCostoProductos">Costo total de productos</span></div>
                </div>
            </div>
            <!-- Detalle por Cliente -->
            <div id="detalleClientes" style="margin-top: 20px;">
                <h3 style="color: #1a3a52; margin-bottom: 12px; font-size: 1em; font-weight: 600;">Detalle por Cliente</h3>
                <div id="detalleClientesContainer"></div>
            </div>
            <button onclick="calcularDespacho()" class="btn-primary" style="margin-top: 15px;">Calcular Despacho</button>
        </section>

        <!-- M√≥dulo 4: Reporte Final Detallado -->
        <section class="card" id="reporteSection" style="display:none;">
            <h2>Reporte Final de Cotizaci√≥n</h2>

            <h3>Por Producto</h3>
            <div class="table-responsive">
                <table id="tablaProductos">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Destino</th>
                            <th>Distancia (km)</th>
                            <th>Producto</th>
                            <th>Unidades</th>
                            <th>Vol. Unit. (m¬≥)</th>
                            <th>Vol. Total (m¬≥)</th>
                            <th>Peso Unit. (kg)</th>
                            <th>Peso Total (kg)</th>
                            <th>Precio Unit.</th>
                            <th>Valor Total</th>
                            <th>Flete Asignado</th>
                            <th>% Flete/Venta</th>
                        </tr>
                    </thead>
                    <tbody id="tablaProductosBody"></tbody>
                </table>
            </div>

            <h3>Por Cliente</h3>
            <div class="table-responsive">
                <table id="tablaClientes">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Destino</th>
                            <th>Distancia (km)</th>
                            <th>Vol. Total (m¬≥)</th>
                            <th>Peso Total (kg)</th>
                            <th>Factor (Vol√óDist)</th>
                            <th>% Particip. Flete</th>
                            <th>Valor Total</th>
                            <th>Flete Total</th>
                            <th>% Flete/Venta</th>
                        </tr>
                    </thead>
                    <tbody id="tablaClientesBody"></tbody>
                </table>
            </div>

            <h3>An√°lisis del Modelo Mixto</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- Dimensi√≥n Operativa -->
                <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border: 1px solid #bfdbfe;">
                    <h4 style="color: #1e40af; margin: 0 0 15px 0; font-size: 1em;">üì¶ Dimensi√≥n Operativa (Volumen)
                    </h4>
                    <div id="resumenOperativo"></div>
                </div>

                <!-- Dimensi√≥n Financiera -->
                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border: 1px solid #bbf7d0;">
                    <h4 style="color: #166534; margin: 0 0 15px 0; font-size: 1em;">üí∞ Dimensi√≥n Financiera (Peso)</h4>
                    <div id="resumenFinanciero"></div>
                </div>
            </div>

            <div class="actions">
                <button onclick="exportarReporte()" class="btn-secondary">Exportar Reporte</button>
                <button onclick="nuevoDespacho()" class="btn-secondary">Nuevo Despacho</button>
            </div>
        </section>

        <!-- Ejemplo de tabla de asignaci√≥n de flete por volumen -->
        <h2 style="margin-top:32px;">Ejemplo de tabla de asignaci√≥n de flete por volumen</h2>
        <div style="overflow-x:auto; max-width:100vw;">
            <table style="margin-top:12px; min-width:900px;">
                <thead>
                    <tr>
                        <th>N¬∞ Ruta</th>
                        <th>Nombre Ruta</th>
                        <th>Tipo Veh√≠culo</th>
                        <th>Costo Flete ($)</th>
                        <th>Canal</th>
                        <th>ID Producto</th>
                        <th>Descripci√≥n Producto</th>
                        <th>Medidas (m)</th>
                        <th>Unidades</th>
                        <th>Vol. Unitario (m¬≥)</th>
                        <th>Vol. Total (m¬≥)</th>
                        <th>Ocupaci√≥n Volum√©trica (%)</th>
                        <th>Valor m¬≥ (Flete/Cami√≥n)</th>
                        <th>Valor Flete Producto</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>08</td>
                        <td>ALBAN - SASAIMA - VILLETA - GUADUAS - HONDA</td>
                        <td>25 m¬≥</td>
                        <td>970.659</td>
                        <td>Tradicional</td>
                        <td>90050271</td>
                        <td>COLCH√ìN MONARCA 100X190X28 JAC</td>
                        <td>1.00 x 1.90 x 0.28</td>
                        <td>6</td>
                        <td>0.53</td>
                        <td>3.18</td>
                        <td>12.72%</td>
                        <td>38.826,36</td>
                        <td>123.947,76</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modelos -->
    <script src="models/RutaModel.js"></script>

    <!-- Base de Datos (opcional - si existe BD) -->
    <script src="config/database.js"></script>
    <script src="database/DatabaseAdapter.js"></script>

    <!-- Vistas -->
    <script src="views/ConfiguracionViajeView.js"></script>
    <script src="views/ClientesView.js"></script>
    <script src="views/ResumenView.js"></script>
    <script src="views/ReportesView.js"></script>

    <!-- Controlador -->
    <script src="controllers/AppController.js"></script>

    <!-- Aplicaci√≥n Principal -->
    <script src="assets/js/app.js"></script>
    
    <!-- Manejador de Destinos -->
    <script src="assets/js/destinos-handler.js"></script>
</body>

</html>